<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<script src = "https://code.jquery.com/jquery.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">

<style>
	h2, h3 { text-align: center;}
	h3     { margin-top :30px; }
	#container { 
	    display : flex;
	    justify-content: space-around;
	}
	#box1 {
	    width: 60%; 
	    border: 2px solid black;
	    border-radius : 10px;
	    padding: 10px;
	}
	#box2 {
	    width: 30%;
	    border: 2px solid black;
	    border-radius : 10px;
	    padding: 10px; 
	}

</style>
</head>
<body>
	<h2>Article Rest Api Test</h2>
	<div id="container">
	  <div id="box1">
        <form>
		  <div class="row mb-3">
		    <!-- col-sm-2 : 2/12, col-sm-10 : 10/12 -->
		    <label for="id"    class="col-form-label col-sm-2">아이디</label>
		    <div class="col-sm-10">
		       <input type="text" class="form-control" id="id" >
		    </div>		    
		  </div>
		  <div class="row mb-3">
		    <label for="title"   class="col-form-label col-sm-2">제목</label>
		    <div class="col-sm-10">
		       <input type="text"   class="form-control" id="title" >
		    </div>   		    
		  </div>
		  <div class="mb-3">		    
		    <label for="content"    class="form-label">내용</label>
		    <textarea class="form-control" id="content" rows="4"></textarea>		    
		  </div>
		  
		  </form>
	  </div>
      <div class="list-group" id="box2">
		  <a href="/api/articles"  id="getlist"
		     class="list-group-item list-group-item-action" aria-current="true">
		    목록조회
		  </a>
		  <a href="/api/articles" id="get" 
		     class="list-group-item list-group-item-action">
		     한개 조회
		  </a>
		  <a href="/api/articles" id="post" 
		     class="list-group-item list-group-item-action">
		     추가
		  </a>
		  <a href="/api/articles"id="patch"
		     class="list-group-item list-group-item-action">
		     수정
		  </a>
		  <a href="/api/articles" id="delete" 
		     class="list-group-item list-group-item-action" 
		     tabindex="-1" aria-disabled="false">
		     삭제
		  </a>
		</div>

	  </div>
</head>
<body>

<!-- <h2>article restApi Test</h2>
	<ul>
		<li><a id = "getlist" href ="/api/articles">목록조회</a></li>
		<li><a id = "get" href ="/api/articles/2">목록한개조회</a></li>
		<li><a id = "post" href ="/api/articles/3">추가</a></li>
		<li><a id = "patch" href ="/api/articles/4">수정</a></li>
		<li><a id = "delete" href ="/api/articles/5">삭제</a></li>
	</ul>-->
<h3>결과</h3> 



<div id = "result" ></div> 
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
<script>
	function makeTable(list){
		let table = '<table class ="table table-striped mx-auto" style = "width:90%">'
			table += '<tr class = "table-dark">';
			table += '<td>번호</td>';
			table += '<td>제목</td>';
			table += '<td>내용</td>';
			table += '</tr>';
			
		list.forEach(function(article){
			table += `<tr>`
			table += `<td>${article.id}</td>`
			table += `<td>${article.title}</td>`
			table += `<td>${article.content}</td>`
			table += `</tr>`
		})
		table += '</table>';
		return table;
	}
</script> 
<script>
	const aEls      =  document.querySelectorAll('a') //a 태그 배열
	const idEl      =  document.querySelector('#id');
    const titleEl   =  document.querySelector('#title');
    const contentEl =  document.querySelector('#content');
    const patchLink = document.querySelector('#patch');
	const resultEl  =  document.querySelector('#result') //a 태그 배열
		
		
		//리스트 목록 보여주기
		function fetchList(){
		  fetch('/api/articles', {
		        method: 'GET'
		    })
		    .then(response => response.json())
		    .then(list => {
		        console.log(list);
		        resultEl.innerHTML = makeTable(list);
		    })
		    .catch(error => {
		        console.log(error);
		    });
		}

		
		aEls.forEach(function (a){
				a.onclick = function(event){
				event.preventDefault(); // a tag의 기본이벤트를 취소
				event.stopPropagation(); // 이벤트 버블링을 중지 
				console.log(a.id);
				//alert(a.innerHTML);
				switch(a.id){
				
				
				//================목록보기================
				case 'getlist':
					//api controller 실행데이터 받아온다(fetch)
					fetch(a.href)
					.then(response => response.json())
					.then(list => {
						console.log(list)
						resultEl.innerHTML = makeTable(list);
					})
					.then(error => console.log(error))
					break;
					
					//================추가================
				   case 'post':
				   	   if(titleEl.value.trim() == '') {
				   		   alert('제목을 입력하세요')
				   		   break;
				   	   }else if (contentEl.value.trim() == ''){
				   		   alert('내용을 입력하세요')
				   	   }
				   
					   fetch( a.href , {
						   method: 'POST',
						   body: JSON.stringify({     // 서버 data 를 보낼떄 json 문자열로 전송
						     title  : titleEl.value,
						     content: contentEl.value
						   }),
						   headers: {
						     'Content-type': 'application/json; charset=UTF-8',
						   },
						 })
						   .then((response) => {
							 if(response.ok){
								 
								 return response.json();
								 
							 } else{
								 throw new Error(`수정 실패: ${response.status}`);						 
							 }
						   })
						   
						    .then(data => {
					        console.log('추가 성공!', data);
					        alert('게시글번호:' + idEl.value + '이 성공적으로 추가되었습니다.');
					        
					        //삭제 후 fetchList() 함수 호출 
					        return fetchList();
					    	})
					    	.catch(error => {
					        console.error('에러 발생:', error.message);
					        alert('게시글 추가 중 오류가 발생했습니다.');
					    	});
					    	break;
					   
					 //================수정================
				   case 'patch': 
					    // ID가 없으면 경고 메시지 표시
					   const updateId = idEl.value
					   if(!updateId){
						   alert('수정할 id를 입력해주세요')
						   return;
					   }

					    const updatedData = {
					        title: titleEl.value,
					        content: contentEl.value
					    };
						if(!titleEl.value){
							alert('수정할 제목을 입력해주세요')
							return;
						}else if(!contentEl.value){
							alert('수정할 내용을 입력해주세요.')
							return;
						}
					    
					    // PATCH 요청 보내기
					    fetch(`/api/article/${updateId}`, { // ID를 URL에 포함하여 서버에 보내
					        method: 'PATCH',
					        body: JSON.stringify(updatedData),
					        headers: {
					            'Content-type': 'application/json; charset=UTF-8'
					        },
					    })
					    .then(response => {
					        // 응답 상태 코드가 200번대(성공)인지 확인
					        if (response.ok) {
					            // 성공 응답이면 JSON으로 변환
					            return response.json(); 
					        } else {
					            // 실패 응답이면 에러 발생
					            throw new Error(`수정 실패: ${response.status}`);
					        }
					    })
					    .then(data => {
					        console.log('수정 성공!', data);
					        alert('게시글이 성공적으로 수정되었습니다.');
					        return fetchList();
					    })
					    .catch(error => {
					        console.error('에러 발생:', error.message);
					        alert('게시글 수정 중 오류가 발생했습니다.');
					    });
					    break;
					    
					   
					//================삭제===============
				   case 'delete':  
					   const  delId = idEl.value;
					   if(!delId){
						   alert('삭제할 id를 입력해주세요');
						return;					   
					   }
					   
					   fetch( `/api/article/${delId}` , {
					   method: 'DELETE',
					   headers:{'Content-type': 'application/json; charset=UTF-8'}})
					 .then(response => {
					 if(response.ok){
						 alert('삭제성공');
						 console.log('삭제성공!');
						 return fetchList();
					 }else{
						 throw new Error(`삭제실패:${response.status}`);
					 }
					})
					.catch(error =>{ //에러가 발생하면
						console.error ('에러:', error.message);
						alert('삭제 중 오류가 발생했습니다.');
					}) 
					break;  
					 
					 
					//================해당 id 조회===============
				   	case 'get':
						const getId = idEl.value;
						if(!getId){
							alert('조회 id를 입력해주세요')
							return ;
						}
						
						
						
					   	fetch(`/api/article/${getId}`,{
					   	method : 'GET',
						   headers: {
						     'Content-type': 'application/json; charset=UTF-8',
						   },
						 })
						  	.then((response) => {
						  		if(response.ok){
						  			return response.json();
						  		}else{
						  			throw new Error(`조회실패 : ${response.status}`);
						  		}
						  	})
							.then((json) =>{
								
								 const articleList = [json];
								 resultEl.innerHTML = makeTable(articleList);
								 
								console.log('조회성공', json);
								alert('게시글을 성공적으로 조회함');
							})						 
							.catch(error =>{
								console.error('에러:', error.message);
								alert(`[${getId}의 해당하는 번호가 없음]` +  error.message);
							})
					   break;	
				 }
			   }
		   })
</script>
</body>
</html>